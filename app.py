    from flask import Flask, request, abort
    from linebot import LineBotApi, WebhookHandler
    from linebot.exceptions import InvalidSignatureError
    from linebot.models import MessageEvent, TextMessage, TextSendMessage, FollowEvent
    import os, random, atexit
    from apscheduler.schedulers.background import BackgroundScheduler

    app = Flask(__name__)

    from dotenv import load_dotenv
    load_dotenv()

    LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
    LINE_CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")

    line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
    handler = WebhookHandler(LINE_CHANNEL_SECRET)

    broadcast_active = False
    tasbih_count = {}

    # ---------------- ุงูุฃุฐูุงุฑ ูุงูุฃุฏุนูุฉ ูุงููุฉ ----------------
    adhkar = {
        "ุงุฐูุงุฑ ุงูุตุจุงุญ": """โ๏ธ ุฃุฐูุงุฑ ุงูุตุจุงุญ:
ุฃุตุจุญูุง ูุฃุตุจุญ ุงูููู ูููุ ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ. ุฑุจ ุฃุณุฃูู ุฎูุฑ ูุง ูู ูุฐุง ุงูููู ูุฎูุฑ ูุง ุจุนุฏูุ ูุฃุนูุฐ ุจู ูู ุดุฑ ูุง ูู ูุฐุง ุงูููู ูุดุฑ ูุง ุจุนุฏูุ ุฑุจ ุฃุนูุฐ ุจู ูู ุงููุณู ูุณูุก ุงููุจุฑุ ุฑุจ ุฃุนูุฐ ุจู ูู ุนุฐุงุจ ูู ุงููุงุฑ ูุนุฐุงุจ ูู ุงููุจุฑ.

ุงูููู ุจู ุฃุตุจุญูุงุ ูุจู ุฃูุณููุงุ ูุจู ูุญูุงุ ูุจู ูููุชุ ูุฅููู ุงููุดูุฑ.

ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู (3 ูุฑุงุช).

ุจุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู (3 ูุฑุงุช).

ุงูููู ุฅูู ุฃุตุจุญุช ุฃุดูุฏู ูุฃุดูุฏ ุญููุฉ ุนุฑุดู ูููุงุฆูุชู ูุฌููุน ุฎููู ุฃูู ุฃูุช ุงููู ูุง ุฅูู ุฅูุง ุฃูุช ูุญุฏู ูุง ุดุฑูู ูู ูุฃู ูุญูุฏุงู ุนุจุฏู ูุฑุณููู (4 ูุฑุงุช).

ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ูู ุนููู ุชูููุช ููู ุฑุจ ุงูุนุฑุด ุงูุนุธูู (7 ูุฑุงุช).

ุขูุฉ ุงููุฑุณู + ุงููุนูุฐุงุช (ุงูุฅุฎูุงุตุ ุงููููุ ุงููุงุณ 3 ูุฑุงุช).""",

        "ุงุฐูุงุฑ ุงููุณุงุก": """๐ ุฃุฐูุงุฑ ุงููุณุงุก:
ุฃูุณููุง ูุฃูุณู ุงูููู ูููุ ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ. ุฑุจ ุฃุณุฃูู ุฎูุฑ ูุง ูู ูุฐู ุงููููุฉ ูุฎูุฑ ูุง ุจุนุฏูุงุ ูุฃุนูุฐ ุจู ูู ุดุฑ ูุง ูู ูุฐู ุงููููุฉ ูุดุฑ ูุง ุจุนุฏูุงุ ุฑุจ ุฃุนูุฐ ุจู ูู ุงููุณู ูุณูุก ุงููุจุฑุ ุฑุจ ุฃุนูุฐ ุจู ูู ุนุฐุงุจ ูู ุงููุงุฑ ูุนุฐุงุจ ูู ุงููุจุฑ.

ุงูููู ุจู ุฃูุณููุงุ ูุจู ุฃุตุจุญูุงุ ูุจู ูุญูุงุ ูุจู ูููุชุ ูุฅููู ุงููุตูุฑ.

ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู (3 ูุฑุงุช).

ุจุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู (3 ูุฑุงุช).

ุงูููู ุฅูู ุฃูุณูุช ุฃุดูุฏู ูุฃุดูุฏ ุญููุฉ ุนุฑุดู ูููุงุฆูุชู ูุฌููุน ุฎููู ุฃูู ุฃูุช ุงููู ูุง ุฅูู ุฅูุง ุฃูุช ูุญุฏู ูุง ุดุฑูู ูู ูุฃู ูุญูุฏุงู ุนุจุฏู ูุฑุณููู (4 ูุฑุงุช).

ุญุณุจู ุงููู ูุง ุฅูู ุฅูุง ูู ุนููู ุชูููุช ููู ุฑุจ ุงูุนุฑุด ุงูุนุธูู (7 ูุฑุงุช).

ุขูุฉ ุงููุฑุณู + ุงููุนูุฐุงุช (ุงูุฅุฎูุงุตุ ุงููููุ ุงููุงุณ 3 ูุฑุงุช).""",

        "ุฏุนุงุก ุจุนุฏ ุงูุตูุงุฉ": """๐ ุฏุนุงุก ุจุนุฏ ุงูุตูุงุฉ:
ุฃุณุชุบูุฑ ุงููู (3 ูุฑุงุช).
ุงูููู ุฃูุช ุงูุณูุงู ูููู ุงูุณูุงู ุชุจุงุฑูุช ูุง ุฐุง ุงูุฌูุงู ูุงูุฅูุฑุงู.

ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑุ ุงูููู ูุง ูุงูุน ููุง ุฃุนุทูุช ููุง ูุนุทู ููุง ููุนุช ููุง ูููุน ุฐุง ุงูุฌุฏ ููู ุงูุฌุฏ.

ุงูุชุณุจูุญ: 33 ุณุจุญุงู ุงููู + 33 ุงูุญูุฏ ููู + 33 ุงููู ุฃูุจุฑ + ุชูุงู ุงููุงุฆุฉ: ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑ.""",

        "ุฏุนุงุก ุงูููู": """๐ ุฏุนุงุก ุงูููู:
ุจุงุณูู ุฑุจู ูุถุนุช ุฌูุจู ูุจู ุฃุฑูุนูุ ุฅู ุฃูุณูุช ููุณู ูุงุฑุญููุง ูุฅู ุฃุฑุณูุชูุง ูุงุญูุธูุง ุจูุง ุชุญูุธ ุจู ุนุจุงุฏู ุงูุตุงูุญูู.

ูุฑุงุกุฉ: ุขูุฉ ุงููุฑุณู.
ูุฑุงุกุฉ: ุงููุนูุฐุงุช (ุงูุฅุฎูุงุตุ ุงููููุ ุงููุงุณ) 3 ูุฑุงุช.

ุณุจุญุงู ุงููู 33ุ ุงูุญูุฏ ููู 33ุ ุงููู ุฃูุจุฑ 34.""",

        "ุฏุนุงุก ุงูุงุณุชููุงุธ": """๐ ุฏุนุงุก ุงูุงุณุชููุงุธ:
ุงูุญูุฏ ููู ุงูุฐู ุฃุญูุงูุง ุจุนุฏูุง ุฃูุงุชูุง ูุฅููู ุงููุดูุฑ.

ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏ ููู ุนูู ูู ุดูุก ูุฏูุฑุ ุณุจุญุงู ุงูููุ ูุงูุญูุฏ ูููุ ููุง ุฅูู ุฅูุง ุงูููุ ูุงููู ุฃูุจุฑุ ููุง ุญูู ููุง ููุฉ ุฅูุง ุจุงููู ุงูุนูู ุงูุนุธูู.""",

        "ุฏุนุงุก ุงูุฌูุนุฉ": "ุงูููู ุงุฌุนููุง ูู ุงูููุจูููู ูู ููู ุงูุฌูุนุฉุ ุงูููู ุงุบูุฑ ููุง ูุง ูุฏููุง ููุง ุฃุฎุฑูุง ููุง ุฃุณุฑุฑูุง ููุง ุฃุนููุง.",
        "ุฏุนุงุก ุงูุณูุฑ": "ุงูููู ุฅูุง ูุณุฃูู ูู ุณูุฑูุง ูุฐุง ุงูุจุฑ ูุงูุชููู ููู ุงูุนูู ูุง ุชุฑุถูุ ุงูููู ููู ุนูููุง ุณูุฑูุง ูุฐุง ูุงุทูู ุนูุง ุจุนุฏูุ ุงูููู ุฃูุช ุงูุตุงุญุจ ูู ุงูุณูุฑ ูุงูุฎูููุฉ ูู ุงูุฃูู.",
        "ุฏุนุงุก ุฏุฎูู ุงููุณุฌุฏ": "ุงูููู ุงูุชุญ ูู ุฃุจูุงุจ ุฑุญูุชู.",
        "ุฏุนุงุก ุงูุฎุฑูุฌ ูู ุงููุณุฌุฏ": "ุงูููู ุฅูู ุฃุณุฃูู ูู ูุถูู.",
        "ุฏุนุงุก ุงูุฎุฑูุฌ ูู ุงูููุฒู": "ุจุณู ุงูููุ ุชูููุช ุนูู ุงูููุ ููุง ุญูู ููุง ููุฉ ุฅูุง ุจุงููู.",
        "ุฏุนุงุก ุงููุฑุจ": "ูุง ุฅูู ุฅูุง ุงููู ุงูุนุธูู ุงูุญูููุ ูุง ุฅูู ุฅูุง ุงููู ุฑุจ ุงูุนุฑุด ุงูุนุธููุ ูุง ุฅูู ุฅูุง ุงููู ุฑุจ ุงูุณูุงูุงุช ูุฑุจ ุงูุฃุฑุถ ูุฑุจ ุงูุนุฑุด ุงููุฑูู.",
        "ุฏุนุงุก ุงูุงุณุชุฎุงุฑุฉ": "ุงูููู ุฅูู ุงุณุชุฎูุฑู ุจุนูููุ ูุฃุณุชูุฏุฑู ุจูุฏุฑุชูุ ูุฃุณุฃูู ูู ูุถูู ุงูุนุธููุ ูุฅูู ุชูุฏุฑ ููุง ุฃูุฏุฑ ูุชุนูู ููุง ุฃุนูู ูุฃูุช ุนูุงู ุงูุบููุจ...",
        "ุฏุนุงุก ุงูุฑุฒู": "ุงูููู ุงุฑุฒููู ุฑุฒูุงู ุญูุงูุงู ุทูุจุงู ูุงุณุนุงู ูุจุงุฑูุงู ููู."
    }

    quran = {
        "ุณูุฑุฉ ุงููุงุชุญุฉ": "ุจุณู ุงููู ุงูุฑุญูู ุงูุฑุญูู. ุงูุญูุฏ ููู ุฑุจ ุงูุนุงูููู * ุงูุฑุญูู ุงูุฑุญูู * ูุงูู ููู ุงูุฏูู * ุฅูุงู ูุนุจุฏ ูุฅูุงู ูุณุชุนูู * ุงูุฏูุง ุงูุตุฑุงุท ุงููุณุชููู * ุตุฑุงุท ุงูุฐูู ุฃูุนูุช ุนูููู ุบูุฑ ุงููุบุถูุจ ุนูููู ููุง ุงูุถุงููู.",
        "ุณูุฑุฉ ุงูููู": "ุงูุญูุฏ ููู ุงูุฐู ุฃูุฒู ุนูู ุนุจุฏู ุงููุชุงุจ ููู ูุฌุนู ูู ุนูุฌุง... (ุงูุณูุฑุฉ ูุงููุฉ ุชูุฑุฃ ููู ุงูุฌูุนุฉ).",
        "ุณูุฑุฉ ุงูููู": "ุชุจุงุฑู ุงูุฐู ุจูุฏู ุงูููู ููู ุนูู ูู ุดูุก ูุฏูุฑ... (ุงูุณูุฑุฉ ูุงููุฉ).",
        "ุขูุฉ ุงููุฑุณู": "ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุงููุญูููู ุงูููููููููู... (ุงูุจูุฑุฉ: 255)",
        "ุงููุนูุฐุงุช": "ูููู ูููู ุงูููููู ุฃูุญูุฏู * ุงูููููู ุงูุตููููุฏู * ูููู ููููุฏู ูููููู ูููููุฏู * ูููููู ููููู ููููู ููููููุง ุฃูุญูุฏู. ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงูููููููู... ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงููููุงุณู..."
    }

    ayat = [
        "ููููู ุฑููุจูู ุฒูุฏูููู ุนูููููุง",
        "ุฅูููู ููุนู ุงููุนูุณูุฑู ููุณูุฑูุง",
        "ูุงุฐูุฑููู ุฃุฐูุฑูู",
        "ุงูููููู ููููููู ุงูููุฐูููู ุขูููููุง"
    ]

    ahadith = [
        "ูุงู ุงููุจู ๏ทบ: ุฎูุฑูู ูู ุชุนูู ุงููุฑุขู ูุนููู",
        "ูุงู ุงููุจู ๏ทบ: ุงููููุฉ ุงูุทูุจุฉ ุตุฏูุฉ",
        "ูุงู ุงููุจู ๏ทบ: ูู ุณูู ุทุฑูููุง ููุชูุณ ููู ุนูููุง ุณููู ุงููู ูู ุจู ุทุฑูููุง ุฅูู ุงูุฌูุฉ",
        "ูุงู ุงููุจู ๏ทบ: ูุง ุชุญูุฑู ูู ุงููุนุฑูู ุดูุฆูุง"
    ]

    hikmah = [
        "ูู ุฌุฏ ูุฌุฏ ููู ุฒุฑุน ุญุตุฏ",
        "ุงูุนูู ููุฑ ููุฏู ุฅูู ุงูุญู",
        "ุงูููุฉ ุงูุตุงูุญุฉ ุชุญูู ุงูุนุงุฏุฉ ุฅูู ุนุจุงุฏุฉ"
    ]

    # ---------------- ุงููุดุฑ ุงูุชููุงุฆู ----------------
    scheduler = BackgroundScheduler()

    def send_morning_broadcast():
        if not broadcast_active:
            return
        text = adhkar["ุงุฐูุงุฑ ุงูุตุจุงุญ"] + "\n\n๐ ุขูุฉ ุงูููู:\n" + random.choice(ayat)
        try:
            line_bot_api.broadcast(TextSendMessage(text=text))
        except Exception as e:
            print("Error broadcasting morning:", e)

    def send_evening_broadcast():
        if not broadcast_active:
            return
        text = adhkar["ุงุฐูุงุฑ ุงููุณุงุก"] + "\n\n๐ ุญุฏูุซ ุงูููู:\n" + random.choice(ahadith)
        try:
            line_bot_api.broadcast(TextSendMessage(text=text))
        except Exception as e:
            print("Error broadcasting evening:", e)

    scheduler.add_job(send_morning_broadcast, "cron", hour=7, minute=0)
    scheduler.add_job(send_evening_broadcast, "cron", hour=19, minute=0)
    scheduler.start()
    atexit.register(lambda: scheduler.shutdown())

    WELCOME_TEXT = (
        "๐ ุฃููุงู ุจู ูู ุจูุช ุงูุฃุฐูุงุฑ ูุงููุฑุขู ๐\n\n"
        "๐ ุงูุฃูุงูุฑ:\n"
        "- ุงุฐูุงุฑ ุงูุตุจุงุญ / ุงุฐูุงุฑ ุงููุณุงุก / ุฏุนุงุก ุงูููู / ุฏุนุงุก ุงูุงุณุชููุงุธ / ุฏุนุงุก ุจุนุฏ ุงูุตูุงุฉ\n"
        "- ุฏุนุงุก ุงูุฌูุนุฉ / ุฏุนุงุก ุงูุณูุฑ / ุฏุนุงุก ุฏุฎูู ุงููุณุฌุฏ / ุฏุนุงุก ุงูุฎุฑูุฌ ูู ุงููุณุฌุฏ / ุฏุนุงุก ุงูุฎุฑูุฌ ูู ุงูููุฒู\n"
        "- ุฏุนุงุก ุงููุฑุจ / ุฏุนุงุก ุงูุงุณุชุฎุงุฑุฉ / ุฏุนุงุก ุงูุฑุฒู\n"
        "- ุณูุฑุฉ ุงููุงุชุญุฉ / ุณูุฑุฉ ุงูููู / ุณูุฑุฉ ุงูููู / ุขูุฉ ุงููุฑุณู / ุงููุนูุฐุงุช\n"
        "- ุขูุฉ ุงูููู / ุญุฏูุซ ุงูููู / ุญููุฉ ุงูููู\n"
        "- ุงูุชุณุจูุญ: ุณุจุญุงู ุงููู / ุงูุญูุฏ ููู / ุงููู ุฃูุจุฑ\n"
        "- ุชุดุบูู (ุชูุนูู ุงููุดุฑ) / ุงููุงู / ูุณุงุนุฏุฉ"
    )

    @handler.add(FollowEvent)
    def handle_follow(event):
        try:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=WELCOME_TEXT))
        except Exception as e:
            print("FollowEvent error:", e)

    @app.route("/callback", methods=["POST"])
    def callback():
        signature = request.headers.get("X-Line-Signature", "")
        body = request.get_data(as_text=True)
        try:
            handler.handle(body, signature)
        except InvalidSignatureError:
            abort(400)
        return "OK"

    @handler.add(MessageEvent, message=TextMessage)
    def handle_message(event):
        global broadcast_active, tasbih_count
        text = event.message.text.strip()
        user_id = getattr(event.source, "user_id", None)

        if text == "ุงููุงู":
            broadcast_active = False
            reply = "๐ซ ุชู ุฅููุงู ุงููุดุฑ ุงูุชููุงุฆู."
        elif text in ["ุชุดุบูู", "ุชูุนูู"]:
            broadcast_active = True
            reply = "โ ุชู ุชูุนูู ุงููุดุฑ ุงูุชููุงุฆู (ุฃุฐูุงุฑ ุงูุตุจุงุญ 7:00ุ ุงููุณุงุก 19:00)."
        elif text == "ูุณุงุนุฏุฉ":
            reply = WELCOME_TEXT
        elif text in adhkar:
            reply = adhkar[text]
        elif text in quran:
            reply = quran[text]
        elif text == "ุขูุฉ ุงูููู":
            reply = random.choice(ayat)
        elif text == "ุญุฏูุซ ุงูููู":
            reply = random.choice(ahadith)
        elif text == "ุญููุฉ ุงูููู":
            reply = random.choice(hikmah)
        elif text in ["ุณุจุญุงู ุงููู", "ุงูุญูุฏ ููู", "ุงููู ุฃูุจุฑ"]:
            if user_id:
                tasbih_count.setdefault(user_id, 0)
                tasbih_count[user_id] += 1
                reply = f"{text} ({tasbih_count[user_id]})"
            else:
                reply = text
        else:
            reply = "โ ูู ุฃููู ุงูุฃูุฑ. ุงูุชุจ (ูุณุงุนุฏุฉ) ูุนุฑุถ ุงูุฃูุงูุฑ."

        try:
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply))
        except Exception as e:
            print("reply error:", e)

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", 5000))
        app.run(host="0.0.0.0", port=port)
